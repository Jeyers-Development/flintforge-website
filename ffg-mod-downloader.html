<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flintforge Mod Downloader</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  .mod { margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
  button { margin-top: 5px; }
</style>
</head>
<body>
<h1>Available Mods</h1>
<div id="modsList">Loading mods...</div>

<script>
const METADATA_URL = 'https://pub-44c5b0ce21ec488ba34d865660315ce0.r2.dev/mods_metadata.json';
const BASE_URL = 'https://pub-44c5b0ce21ec488ba34d865660315ce0.r2.dev/mods/';

async function loadMods() {
  const modsDiv = document.getElementById('modsList');
  modsDiv.textContent = 'Loading mods...';

  try {
    const res = await fetch(METADATA_URL);
    if (!res.ok) throw new Error('Failed to fetch metadata');
    const metadata = await res.json();

    modsDiv.textContent = ''; // clear loading text

    for (const hash in metadata) {
      const mod = metadata[hash];
      modsDiv.appendChild(createModElement(mod));
    }

    if (!Object.keys(metadata).length) {
      modsDiv.textContent = 'No mods available.';
    }
  } catch (err) {
    modsDiv.textContent = 'Error loading mods: ' + err.message;
  }
}

// Helper to create mod element
function createModElement(mod) {
  const filename = mod.originalName || 'unknown.jop';
  const title = mod.title || filename;
  const versions = mod.gameversions || "Unspecified Versions";
  const username = mod.username || 'Unknown/Lost';
  const authors = mod.authors || mod.username;
  const description = mod.description || 'No description...';
  const downloads = mod.downloads || 0;

  const div = document.createElement('div');
  div.className = 'mod';

  div.innerHTML = `
    <div><h2><strong>${title}</strong></h2></div>
	<div><strong>Game Versions: ${versions}</strong></div>
	<div><strong>Downloads: ${downloads}</strong></div>
	<div>Created By: ${authors}</div>
	<div>Uploaded By: ${username}</div>
	<div>${description}</div>
  `;

  const btn = document.createElement('button');
  btn.textContent = 'Download';
  btn.onclick = async () => {
	  try {
		const res = await fetch(`https://mod-uploader-worker.jakejem2010.workers.dev?action=download&name=${encodeURIComponent(filename)}`);
		if (!res.ok) throw new Error('Download failed');
		const data = await res.json();

		// Open the download URL returned by the worker
		const link = document.createElement('a');
		link.href = data.url;
		link.download = filename;
		link.click();
	  } catch (err) {
		alert('Error downloading mod: ' + err.message);
	  }
	};


  div.appendChild(btn);
  return div;
}

// Load mods on page load
loadMods();
</script>
</body>
</html>
